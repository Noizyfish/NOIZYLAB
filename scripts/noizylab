#!/bin/bash
#===============================================================================
# NOIZYLAB - Master CLI Tool
# Unified interface for all NOIZYLAB tools and utilities
#===============================================================================

set -e

VERSION="2.0.0"
SCRIPTS_DIR="$(cd "$(dirname "$0")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

#===============================================================================
# BANNER
#===============================================================================

print_banner() {
    echo -e "${PURPLE}${BOLD}"
    cat << 'EOF'
    _   _  ___ ___ _______   ___      _    ____
   | \ | |/ _ \_ _|__  /\ \ / / |    / \  | __ )
   |  \| | | | | |  / /  \ V /| |   / _ \ |  _ \
   | |\  | |_| | | / /_   | | | |__/ ___ \| |_) |
   |_| \_|\___/___/____|  |_| |____/_/   \_\____/

EOF
    echo -e "${NC}"
    echo -e "${CYAN}  Version $VERSION - Ultimate Code Management Toolkit${NC}"
    echo ""
}

print_mini_banner() {
    echo -e "${PURPLE}${BOLD}NOIZYLAB${NC} ${CYAN}v$VERSION${NC}"
}

#===============================================================================
# HELP
#===============================================================================

show_help() {
    print_banner
    echo -e "${BOLD}USAGE:${NC}"
    echo "  noizylab <command> [subcommand] [options]"
    echo ""
    echo -e "${BOLD}COMMANDS:${NC}"
    echo ""
    echo -e "  ${GREEN}extract${NC}     Extract and migrate code from external drives"
    echo "              noizylab extract [source] [dest]"
    echo "              noizylab extract --scan [path]"
    echo ""
    echo -e "  ${GREEN}backup${NC}      Backup and sync operations"
    echo "              noizylab backup [source] [dest]"
    echo "              noizylab backup sync [source] [dest]"
    echo "              noizylab backup mirror [source] [dest]"
    echo "              noizylab backup watch [source] [dest] [interval]"
    echo ""
    echo -e "  ${GREEN}permissions${NC} Fix file and directory permissions"
    echo "              noizylab permissions [path]"
    echo "              noizylab permissions --quick [path]"
    echo ""
    echo -e "  ${GREEN}integrity${NC}   File integrity verification"
    echo "              noizylab integrity generate [path]"
    echo "              noizylab integrity verify [path]"
    echo "              noizylab integrity duplicates [path]"
    echo ""
    echo -e "  ${GREEN}duplicates${NC}  Find and clean duplicate files"
    echo "              noizylab duplicates scan [path]"
    echo "              noizylab duplicates clean [path]"
    echo "              noizylab duplicates --dry-run [path]"
    echo ""
    echo -e "  ${GREEN}git${NC}         Git repository management"
    echo "              noizylab git find [path]"
    echo "              noizylab git update [path]"
    echo "              noizylab git dirty [path]"
    echo "              noizylab git backup [path]"
    echo ""
    echo -e "  ${GREEN}stats${NC}       Code statistics and analysis"
    echo "              noizylab stats [path]"
    echo "              noizylab stats --quick [path]"
    echo "              noizylab stats largest [path]"
    echo ""
    echo -e "  ${GREEN}security${NC}    Security scanning"
    echo "              noizylab security scan [path]"
    echo "              noizylab security secrets [path]"
    echo "              noizylab security deps [path]"
    echo ""
    echo -e "  ${GREEN}automation${NC}  Setup automated tasks"
    echo "              noizylab automation install"
    echo "              noizylab automation uninstall"
    echo "              noizylab automation list"
    echo ""
    echo -e "  ${GREEN}doctor${NC}      System health check"
    echo "              noizylab doctor"
    echo ""
    echo -e "  ${GREEN}version${NC}     Show version information"
    echo -e "  ${GREEN}help${NC}        Show this help message"
    echo ""
    echo -e "${BOLD}EXAMPLES:${NC}"
    echo "  noizylab extract /Volumes/4TBSG /Users/m2ultra/NOIZYLAB"
    echo "  noizylab backup sync /Volumes/4TBSG ~/Code"
    echo "  noizylab permissions /Volumes/4TBSG"
    echo "  noizylab security scan ~/projects"
    echo "  noizylab git update ~/projects"
    echo ""
    echo -e "${BOLD}CONFIGURATION:${NC}"
    echo "  Default source:      /Volumes/4TBSG"
    echo "  Default destination: /Users/m2ultra/NOIZYLAB"
    echo "  Config directory:    ~/.noizylab"
    echo "  Logs directory:      ~/.noizylab/logs"
    echo ""
}

#===============================================================================
# COMMAND HANDLERS
#===============================================================================

cmd_extract() {
    local subcmd="${1:-}"
    shift || true

    case "$subcmd" in
        --scan|scan)
            "$SCRIPTS_DIR/quick-scan.sh" "$@"
            ;;
        --python|python)
            python3 "$SCRIPTS_DIR/extract-code.py" "$@"
            ;;
        --dry-run|dry-run)
            python3 "$SCRIPTS_DIR/extract-code.py" --dry-run "$@"
            ;;
        --help|-h|help)
            echo "Usage: noizylab extract [options] [source] [dest]"
            echo ""
            echo "Options:"
            echo "  --scan      Quick scan without moving files"
            echo "  --python    Use Python extractor (more features)"
            echo "  --dry-run   Preview without making changes"
            ;;
        *)
            "$SCRIPTS_DIR/extract-and-move-code.sh" "$subcmd" "$@"
            ;;
    esac
}

cmd_backup() {
    local subcmd="${1:-backup}"
    shift || true

    "$SCRIPTS_DIR/backup-sync.sh" "$subcmd" "$@"
}

cmd_permissions() {
    local subcmd="${1:-}"

    case "$subcmd" in
        --quick|quick)
            shift
            "$SCRIPTS_DIR/quick-fix-permissions.sh" "$@"
            ;;
        --help|-h|help)
            "$SCRIPTS_DIR/repair-permissions.sh" --help
            ;;
        *)
            "$SCRIPTS_DIR/repair-permissions.sh" -a "$@"
            ;;
    esac
}

cmd_integrity() {
    local subcmd="${1:-verify}"
    shift || true

    "$SCRIPTS_DIR/integrity-checker.sh" "$subcmd" "$@"
}

cmd_duplicates() {
    local subcmd="${1:-scan}"
    shift || true

    case "$subcmd" in
        --dry-run|dry-run)
            "$SCRIPTS_DIR/duplicate-cleaner.sh" dry-run "$@"
            ;;
        *)
            "$SCRIPTS_DIR/duplicate-cleaner.sh" "$subcmd" "$@"
            ;;
    esac
}

cmd_git() {
    local subcmd="${1:-list}"
    shift || true

    "$SCRIPTS_DIR/git-manager.sh" "$subcmd" "$@"
}

cmd_stats() {
    local subcmd="${1:-}"

    case "$subcmd" in
        --quick|quick)
            shift
            "$SCRIPTS_DIR/code-stats.sh" summary "$@"
            ;;
        largest|big)
            shift
            "$SCRIPTS_DIR/code-stats.sh" largest "$@"
            ;;
        projects)
            shift
            "$SCRIPTS_DIR/code-stats.sh" projects "$@"
            ;;
        *)
            "$SCRIPTS_DIR/code-stats.sh" analyze "$@"
            ;;
    esac
}

cmd_security() {
    local subcmd="${1:-scan}"
    shift || true

    "$SCRIPTS_DIR/security-scanner.sh" "$subcmd" "$@"
}

cmd_automation() {
    local subcmd="${1:-list}"
    shift || true

    "$SCRIPTS_DIR/setup-automation.sh" "$subcmd" "$@"
}

cmd_doctor() {
    print_mini_banner
    echo ""
    echo -e "${BOLD}System Health Check${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # Check scripts
    echo -e "${CYAN}Checking scripts...${NC}"
    local scripts=(
        "extract-and-move-code.sh"
        "backup-sync.sh"
        "repair-permissions.sh"
        "integrity-checker.sh"
        "duplicate-cleaner.sh"
        "git-manager.sh"
        "code-stats.sh"
        "security-scanner.sh"
        "setup-automation.sh"
    )

    for script in "${scripts[@]}"; do
        if [ -x "$SCRIPTS_DIR/$script" ]; then
            echo -e "  ${GREEN}✓${NC} $script"
        else
            echo -e "  ${RED}✗${NC} $script (missing or not executable)"
        fi
    done

    echo ""

    # Check dependencies
    echo -e "${CYAN}Checking dependencies...${NC}"
    local deps=("rsync" "git" "python3" "find" "grep" "md5" "shasum")

    for dep in "${deps[@]}"; do
        if command -v "$dep" &>/dev/null; then
            echo -e "  ${GREEN}✓${NC} $dep"
        else
            echo -e "  ${YELLOW}!${NC} $dep (not found)"
        fi
    done

    echo ""

    # Check default paths
    echo -e "${CYAN}Checking paths...${NC}"

    if [ -d "/Volumes/4TBSG" ]; then
        echo -e "  ${GREEN}✓${NC} Source volume mounted: /Volumes/4TBSG"
    else
        echo -e "  ${YELLOW}!${NC} Source volume not mounted: /Volumes/4TBSG"
    fi

    if [ -d "/Users/m2ultra/NOIZYLAB" ]; then
        echo -e "  ${GREEN}✓${NC} Destination exists: /Users/m2ultra/NOIZYLAB"
    else
        echo -e "  ${YELLOW}!${NC} Destination not found: /Users/m2ultra/NOIZYLAB"
    fi

    if [ -d "$HOME/.noizylab" ]; then
        echo -e "  ${GREEN}✓${NC} Config directory: ~/.noizylab"
    else
        echo -e "  ${YELLOW}!${NC} Config directory not created yet"
    fi

    echo ""

    # Check automation
    echo -e "${CYAN}Checking automation...${NC}"
    local agent_count=$(ls "$HOME/Library/LaunchAgents"/com.noizylab.*.plist 2>/dev/null | wc -l | tr -d ' ')
    if [ "$agent_count" -gt 0 ]; then
        echo -e "  ${GREEN}✓${NC} $agent_count LaunchAgents installed"
    else
        echo -e "  ${YELLOW}!${NC} No automation agents installed"
    fi

    echo ""
    echo -e "${GREEN}Health check complete!${NC}"
}

cmd_version() {
    print_mini_banner
    echo ""
    echo "NOIZYLAB Code Management Toolkit"
    echo "Version: $VERSION"
    echo "Scripts: $SCRIPTS_DIR"
    echo ""
    echo "Tools included:"
    echo "  • Code Extractor & Migrator"
    echo "  • Backup & Sync Manager"
    echo "  • Permissions Repair Tool"
    echo "  • File Integrity Checker"
    echo "  • Duplicate Cleaner"
    echo "  • Git Repository Manager"
    echo "  • Code Statistics Generator"
    echo "  • Security Scanner"
    echo "  • Automation Setup"
}

#===============================================================================
# MAIN
#===============================================================================

main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        extract|migrate|move)
            cmd_extract "$@"
            ;;
        backup|sync)
            cmd_backup "$@"
            ;;
        permissions|perms|fix)
            cmd_permissions "$@"
            ;;
        integrity|verify|check)
            cmd_integrity "$@"
            ;;
        duplicates|dups|dup)
            cmd_duplicates "$@"
            ;;
        git|repos)
            cmd_git "$@"
            ;;
        stats|analyze|loc)
            cmd_stats "$@"
            ;;
        security|sec|scan)
            cmd_security "$@"
            ;;
        automation|auto|cron)
            cmd_automation "$@"
            ;;
        doctor|health)
            cmd_doctor
            ;;
        version|--version|-v)
            cmd_version
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo -e "${RED}Unknown command: $cmd${NC}"
            echo ""
            echo "Run 'noizylab help' for usage information."
            exit 1
            ;;
    esac
}

main "$@"
